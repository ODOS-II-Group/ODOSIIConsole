#!groovy
def GIT_URL=scm.getUserRemoteConfigs()[0].getUrl();

def runGitMergeFromBranch(git_branch, git_base_branch, git_repo_url){
   checkout changelog: false, poll: false, scm: [
       $class: 'GitSCM',
       branches: [[name: git_base_branch]],
       doGenerateSubmoduleConfigurations: false,
       extensions: [[
           $class: 'PreBuildMerge',
           options: [fastForwardMode: 'FF', mergeRemote: 'origin', mergeStrategy: 'recursive', mergeTarget: git_branch]
       ]],
       submoduleCfg: [],
       userRemoteConfigs: [[credentialsId: 'jenkins-ssh', url: git_repo_url]]
   ]
   println "Locally merged $git_base_branch to $git_branch"
}

def slack(msg){
  echo msg
  slackSend botUser: true, message: "${JOB_NAME}: ${msg}", tokenCredentialId: 'slack'

}


pipeline {
    agent any

    stages {
        stage('init'){
          steps{
            runGitMergeFromBranch('Staging', 'master', GIT_URL)

            slack "Build ${BUILD_ID} Started."
          }
        }
        stage('Build') {
            steps {
                slack 'Building...'
                dir('ODOS-II-svc3') {
                  sh './gradlew bootRepackage -Pprod'
                }
            }
        }
        stage('Sonar') {
          steps {
            slack 'Sonar Scan and Upload...'
            dir('ODOS-II-svc3') {
              sh './gradlew sonarqube'
            }
          }
        }
        stage('Fortify Scan') {
            steps {
                slack 'Fortify Scan...'
            }
        }
        stage('Containerization') {
            steps {
                slack 'Packaging into a container...'
                dir('ODOS-II-svc3') {
                  withCredentials([usernamePassword(credentialsId: 'odos-password', passwordVariable: 'ODOS_PW', usernameVariable: 'ODOS_USER')]) {
                      sh """
                        docker login -u ${ODOS_USER} -p ${ODOS_PW} docker.lassiterdynamics.com:5000 
                        ./gradlew buildDocker
                      """
                  }
                }
            }
        }
        stage('Twistlock Scan') {
            steps {
                slack 'Twistlock Scan...'
            }
        }
        stage('Push') {
            steps {
              script{
                slack 'Push to Docker Registry..'
                docker.withServer('docker.lassiterdynamics.com:5000', 'odos-password') {
                }
              }
            }
        }
        stage('Test Deploy') {
            steps {
                slack 'Deploying to Test Environment...'
            }
        }
        stage('FT') {
            steps {
                slack 'Functional Testing...'
            }
        }
        stage('PT') {
            steps {
                slack 'Performance Testing...'
            }
        }
        stage('PP Deploy') {
            steps {
                slack 'Deploying to PreProd Environment...'
            }
        }

    }
}
