#!groovy
def GIT_URL=scm.getUserRemoteConfigs()[0].getUrl();

def runGitMergeFromBranch(git_branch, git_base_branch, git_repo_url){
   checkout changelog: false, poll: false, scm: [
       $class: 'GitSCM',
       branches: [[name: git_base_branch]],
       doGenerateSubmoduleConfigurations: false,
       extensions: [[
           $class: 'PreBuildMerge',
           options: [fastForwardMode: 'FF', mergeRemote: 'origin', mergeStrategy: 'recursive', mergeTarget: git_branch]
       ]],
       submoduleCfg: []
   ]
   println "Locally merged $git_base_branch to $git_branch"
}

def slack(msg){
  echo msg
  slackSend botUser: true, message: "${JOB_NAME}: ${msg}", tokenCredentialId: 'slack'

}


pipeline {
    agent any

    stages {
        stage('init'){
          steps{
            runGitMergeFromBranch('Staging', 'master', GIT_URL)

            slack "Build ${BUILD_ID} Started."
          }
        }
        stage('Build') {
            steps {
                slack 'Building...'
                dir('ODOS-II-svc3') {
                  sh './gradlew bootRepackage -Pprod'
                }
            }
        }
        stage('Sonar') {
          steps {
            slack 'Sonar Scan and Upload...'
            dir('ODOS-II-svc3') {
              sh './gradlew sonarqube'
            }
          }
        }
        stage('Fortify Scan') {
            steps {
                slack 'Fortify Scan...'
            }
        }
        stage('Containerization') {
            steps {
                slack 'Packaging into a container...'
                dir('ODOS-II-svc3') {
                  withDockerRegistry([credentialsId: 'odos-password', url: 'docker.lassiterdynamics.com:5000']) {
                    sh './gradlew buildDocker'
                  }
                }
            }
        }
        stage('Twistlock Scan') {
            steps {
                slack 'Twistlock Scan...'
            }
        }
        stage('Test Deploy') {
            steps {
                slack 'Deploying to Test Environment...'
            }
        }
        stage('FT') {
            steps {
                slack 'Functional Testing...'
            }
        }
        stage('PT') {
            steps {
                slack 'Performance Testing...'
            }
        }
        stage('Push') {
            steps {
                slack 'Push to Docker Registry..'
            }
        }
        stage('PP Deploy') {
            steps {
                slack 'Deploying to PreProd Environment...'
            }
        }

    }
}
